// Declare all the commonly used objects as variables for convenience
var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw;(function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})})(),$(window).load(function(){game.init()});var game={init:function(){levels.init(),loader.init(),mouse.init(),game.backgroundMusic=loader.loadSound("audio/gurdonark-kindergarten"),game.slingshotReleasedSound=loader.loadSound("audio/released"),game.bounceSound=loader.loadSound("audio/bounce"),game.breakSound={glass:loader.loadSound("audio/glassbreak"),wood:loader.loadSound("audio/woodbreak")},$(".gamelayer").hide(),$("#gamestartscreen").show(),game.canvas=document.getElementById("gamecanvas"),game.context=game.canvas.getContext("2d")},startBackgroundMusic:function(){var e=$("#togglemusic")[0];game.backgroundMusic.play(),e.src="images/icons/sound.png"},stopBackgroundMusic:function(){var e=$("#togglemusic")[0];e.src="images/icons/nosound.png",game.backgroundMusic.pause(),game.backgroundMusic.currentTime=0},toggleBackgroundMusic:function(){var e=$("#togglemusic")[0];game.backgroundMusic.paused?(game.backgroundMusic.play(),e.src="images/icons/sound.png"):(game.backgroundMusic.pause(),$("#togglemusic")[0].src="images/icons/nosound.png")},showLevelScreen:function(){$(".gamelayer").hide(),$("#levelselectscreen").show("slow")},restartLevel:function(){window.cancelAnimationFrame(game.animationFrame),game.lastUpdateTime=undefined,levels.load(game.currentLevel.number)},startNextLevel:function(){window.cancelAnimationFrame(game.animationFrame),game.lastUpdateTime=undefined,levels.load(game.currentLevel.number+1)},mode:"intro",slingshotX:140,slingshotY:280,start:function(){$(".gamelayer").hide(),$("#gamecanvas").show(),$("#scorescreen").show(),game.startBackgroundMusic(),game.mode="intro",game.offsetLeft=0,game.ended=!1,game.animationFrame=window.requestAnimationFrame(game.animate,game.canvas)},maxSpeed:3,minOffset:0,maxOffset:300,offsetLeft:0,score:0,panTo:function(e){if(Math.abs(e-game.offsetLeft-game.canvas.width/4)>0&&game.offsetLeft<=game.maxOffset&&game.offsetLeft>=game.minOffset){var t=Math.round((e-game.offsetLeft-game.canvas.width/4)/2);return t&&Math.abs(t)>game.maxSpeed&&(t=game.maxSpeed*Math.abs(t)/t),game.offsetLeft+=t,game.offsetLeft<game.minOffset?(game.offsetLeft=game.minOffset,!0):game.offsetLeft>game.maxOffset?(game.offsetLeft=game.maxOffset,!0):!1}return!0},countHeroesAndVillains:function(){game.heroes=[],game.villains=[];for(var e=box2d.world.GetBodyList();e;e=e.GetNext()){var t=e.GetUserData();t&&(t.type=="hero"?game.heroes.push(e):t.type=="villain"&&game.villains.push(e))}},mouseOnCurrentHero:function(){if(!game.currentHero)return!1;var e=game.currentHero.GetPosition(),t=Math.pow(e.x*box2d.scale-mouse.x-game.offsetLeft,2)+Math.pow(e.y*box2d.scale-mouse.y,2),n=Math.pow(game.currentHero.GetUserData().radius,2);return t<=n},handlePanning:function(){game.mode=="intro"&&game.panTo(700)&&(game.mode="load-next-hero"),game.mode=="wait-for-firing"&&(mouse.dragging?game.mouseOnCurrentHero()?game.mode="firing":game.panTo(mouse.x+game.offsetLeft):game.panTo(game.slingshotX));if(game.mode=="firing")if(mouse.down)game.panTo(game.slingshotX),game.currentHero.SetPosition({x:(mouse.x+game.offsetLeft)/box2d.scale,y:mouse.y/box2d.scale});else{game.mode="fired",game.slingshotReleasedSound.play();var e=.75,t=game.slingshotX+35,n=game.slingshotY+25,r=new b2Vec2((t-mouse.x-game.offsetLeft)*e,(n-mouse.y)*e);game.currentHero.ApplyImpulse(r,game.currentHero.GetWorldCenter()),game.currentHero.SetAngularDamping(.5),game.currentHero.SetLinearDamping(.1)}if(game.mode=="fired"){var i=game.currentHero.GetPosition().x*box2d.scale;game.panTo(i);if(!game.currentHero.IsAwake()||i<0||i>game.currentLevel.foregroundImage.width)box2d.world.DestroyBody(game.currentHero),game.currentHero=undefined,game.mode="load-next-hero"}if(game.mode=="load-next-hero"){game.countHeroesAndVillains();if(game.villains.length==0){game.mode="level-success";return}if(game.heroes.length==0){game.mode="level-failure";return}game.currentHero?(game.panTo(game.slingshotX),game.currentHero.IsAwake()||(game.mode="wait-for-firing")):(game.currentHero=game.heroes[game.heroes.length-1],game.currentHero.SetPosition({x:180/box2d.scale,y:200/box2d.scale}),game.currentHero.SetLinearVelocity({x:0,y:0}),game.currentHero.SetAngularVelocity(0),game.currentHero.SetAwake(!0))}(game.mode=="level-success"||game.mode=="level-failure")&&game.panTo(0)&&(game.ended=!0,game.showEndingScreen())},showEndingScreen:function(){game.stopBackgroundMusic(),game.mode=="level-success"?game.currentLevel.number<levels.data.length-1?($("#endingmessage").html("Level Complete. Well Done!!!"),$("#playnextlevel").show()):($("#endingmessage").html("All Levels Complete. Well Done!!!"),$("#playnextlevel").hide()):game.mode=="level-failure"&&($("#endingmessage").html("Failed. Play Again?"),$("#playnextlevel").hide()),$("#endingscreen").show()},animate:function(){game.handlePanning();var e=(new Date).getTime(),t;game.lastUpdateTime&&(t=(e-game.lastUpdateTime)/1e3,t>2/60&&(t=2/60),box2d.step(t)),game.lastUpdateTime=e,game.context.drawImage(game.currentLevel.backgroundImage,game.offsetLeft/4,0,640,480,0,0,640,480),game.context.drawImage(game.currentLevel.foregroundImage,game.offsetLeft,0,640,480,0,0,640,480),game.context.drawImage(game.slingshotImage,game.slingshotX-game.offsetLeft,game.slingshotY),game.drawAllBodies(),(game.mode=="wait-for-firing"||game.mode=="firing")&&game.drawSlingshotBand(),game.context.drawImage(game.slingshotFrontImage,game.slingshotX-game.offsetLeft,game.slingshotY),game.ended||(game.animationFrame=window.requestAnimationFrame(game.animate,game.canvas))},drawAllBodies:function(){box2d.world.DrawDebugData();for(var e=box2d.world.GetBodyList();e;e=e.GetNext()){var t=e.GetUserData();if(t){var n=e.GetPosition().x*box2d.scale;n<0||n>game.currentLevel.foregroundImage.width||t.health&&t.health<0?(box2d.world.DestroyBody(e),t.type=="villain"&&(game.score+=t.calories,$("#score").html("Score: "+game.score)),t.breakSound&&t.breakSound.play()):entities.draw(t,e.GetPosition(),e.GetAngle())}}},drawSlingshotBand:function(){game.context.strokeStyle="rgb(68,31,11)",game.context.lineWidth=6;var e=game.currentHero.GetUserData().radius,t=game.currentHero.GetPosition().x*box2d.scale,n=game.currentHero.GetPosition().y*box2d.scale,r=Math.atan2(game.slingshotY+25-n,game.slingshotX+50-t),i=t-e*Math.cos(r),s=n-e*Math.sin(r);game.context.beginPath(),game.context.moveTo(game.slingshotX+50-game.offsetLeft,game.slingshotY+25),game.context.lineTo(t-game.offsetLeft,n),game.context.stroke(),entities.draw(game.currentHero.GetUserData(),game.currentHero.GetPosition(),game.currentHero.GetAngle()),game.context.beginPath(),game.context.moveTo(i-game.offsetLeft,s),game.context.lineTo(game.slingshotX-game.offsetLeft+10,game.slingshotY+30),game.context.stroke()}},levels={data:[{foreground:"desert-foreground",background:"clouds-background",entities:[{type:"ground",name:"dirt",x:500,y:440,width:1e3,height:20,isStatic:!0},{type:"ground",name:"wood",x:185,y:390,width:30,height:80,isStatic:!0},{type:"block",name:"wood",x:520,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:520,y:280,angle:90,width:100,height:25},{type:"villain",name:"burger",x:520,y:205,calories:590},{type:"block",name:"wood",x:620,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:620,y:280,angle:90,width:100,height:25},{type:"villain",name:"fries",x:620,y:205,calories:420},{type:"hero",name:"orange",x:80,y:405},{type:"hero",name:"apple",x:140,y:405}]},{foreground:"desert-foreground",background:"clouds-background",entities:[{type:"ground",name:"dirt",x:500,y:440,width:1e3,height:20,isStatic:!0},{type:"ground",name:"wood",x:185,y:390,width:30,height:80,isStatic:!0},{type:"block",name:"wood",x:820,y:380,angle:90,width:100,height:25},{type:"block",name:"wood",x:720,y:380,angle:90,width:100,height:25},{type:"block",name:"wood",x:620,y:380,angle:90,width:100,height:25},{type:"block",name:"glass",x:670,y:317.5,width:100,height:25},{type:"block",name:"glass",x:770,y:317.5,width:100,height:25},{type:"block",name:"glass",x:670,y:255,angle:90,width:100,height:25},{type:"block",name:"glass",x:770,y:255,angle:90,width:100,height:25},{type:"block",name:"wood",x:720,y:192.5,width:100,height:25},{type:"villain",name:"burger",x:715,y:155,calories:590},{type:"villain",name:"fries",x:670,y:405,calories:420},{type:"villain",name:"sodacan",x:765,y:400,calories:150},{type:"hero",name:"strawberry",x:30,y:415},{type:"hero",name:"orange",x:80,y:405},{type:"hero",name:"apple",x:140,y:405}]}],init:function(){var e="";for(var t=0;t<levels.data.length;t++){var n=levels.data[t];e+='<input type="button" value="'+(t+1)+'">'}$("#levelselectscreen").html(e),$("#levelselectscreen input").click(function(){levels.load(this.value-1),$("#levelselectscreen").hide()})},load:function(e){box2d.init(),game.currentLevel={number:e,hero:[]},game.score=0,$("#score").html("Score: "+game.score),game.currentHero=undefined;var t=levels.data[e];game.currentLevel.backgroundImage=loader.loadImage("images/backgrounds/"+t.background+".png"),game.currentLevel.foregroundImage=loader.loadImage("images/backgrounds/"+t.foreground+".png"),game.slingshotImage=loader.loadImage("images/slingshot.png"),game.slingshotFrontImage=loader.loadImage("images/slingshot-front.png");for(var n=t.entities.length-1;n>=0;n--){var r=t.entities[n];entities.create(r)}loader.loaded?game.start():loader.onload=game.start}},entities={definitions:{glass:{fullHealth:100,density:2.4,friction:.4,restitution:.15},wood:{fullHealth:500,density:.7,friction:.4,restitution:.4},dirt:{density:3,friction:1.5,restitution:.2},burger:{shape:"circle",fullHealth:40,radius:25,density:1,friction:.5,restitution:.4},sodacan:{shape:"rectangle",fullHealth:80,width:40,height:60,density:1,friction:.5,restitution:.7},fries:{shape:"rectangle",fullHealth:50,width:40,height:50,density:1,friction:.5,restitution:.6},apple:{shape:"circle",radius:25,density:1.5,friction:.5,restitution:.4},orange:{shape:"circle",radius:25,density:1.5,friction:.5,restitution:.4},strawberry:{shape:"circle",radius:15,density:2,friction:.5,restitution:.4}},create:function(e){var t=entities.definitions[e.name];if(!t){console.log("Undefined entity name",e.name);return}switch(e.type){case"block":e.health=t.fullHealth,e.fullHealth=t.fullHealth,e.shape="rectangle",e.sprite=loader.loadImage("images/entities/"+e.name+".png"),e.breakSound=game.breakSound[e.name],box2d.createRectangle(e,t);break;case"ground":e.shape="rectangle",box2d.createRectangle(e,t);break;case"hero":case"villain":e.health=t.fullHealth,e.fullHealth=t.fullHealth,e.sprite=loader.loadImage("images/entities/"+e.name+".png"),e.shape=t.shape,e.bounceSound=game.bounceSound,t.shape=="circle"?(e.radius=t.radius,box2d.createCircle(e,t)):t.shape=="rectangle"&&(e.width=t.width,e.height=t.height,box2d.createRectangle(e,t));break;default:console.log("Undefined entity type",e.type)}},draw:function(e,t,n){game.context.translate(t.x*box2d.scale-game.offsetLeft,t.y*box2d.scale),game.context.rotate(n);switch(e.type){case"block":game.context.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,-e.width/2-1,-e.height/2-1,e.width+2,e.height+2);break;case"villain":case"hero":e.shape=="circle"?game.context.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,-e.radius-1,-e.radius-1,e.radius*2+2,e.radius*2+2):e.shape=="rectangle"&&game.context.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,-e.width/2-1,-e.height/2-1,e.width+2,e.height+2);break;case"ground":}game.context.rotate(-n),game.context.translate(-t.x*box2d.scale+game.offsetLeft,-t.y*box2d.scale)}},box2d={scale:30,init:function(){var e=new b2Vec2(0,9.8),t=!0;box2d.world=new b2World(e,t);var n=document.getElementById("debugcanvas").getContext("2d"),r=new b2DebugDraw;r.SetSprite(n),r.SetDrawScale(box2d.scale),r.SetFillAlpha(.3),r.SetLineThickness(1),r.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),box2d.world.SetDebugDraw(r);var i=new Box2D.Dynamics.b2ContactListener;i.PostSolve=function(e,t){var n=e.GetFixtureA().GetBody(),r=e.GetFixtureB().GetBody(),i=n.GetUserData(),s=r.GetUserData(),o=Math.abs(t.normalImpulses[0]);o>5&&(i.health&&(i.health-=o),s.health&&(s.health-=o),i.bounceSound&&i.bounceSound.play(),s.bounceSound&&s.bounceSound.play())},box2d.world.SetContactListener(i)},step:function(e){box2d.world.Step(e,8,3)},createRectangle:function(e,t){var n=new b2BodyDef;e.isStatic?n.type=b2Body.b2_staticBody:n.type=b2Body.b2_dynamicBody,n.position.x=e.x/box2d.scale,n.position.y=e.y/box2d.scale,e.angle&&(n.angle=Math.PI*e.angle/180);var r=new b2FixtureDef;r.density=t.density,r.friction=t.friction,r.restitution=t.restitution,r.shape=new b2PolygonShape,r.shape.SetAsBox(e.width/2/box2d.scale,e.height/2/box2d.scale);var i=box2d.world.CreateBody(n);i.SetUserData(e);var s=i.CreateFixture(r);return i},createCircle:function(e,t){var n=new b2BodyDef;e.isStatic?n.type=b2Body.b2_staticBody:n.type=b2Body.b2_dynamicBody,n.position.x=e.x/box2d.scale,n.position.y=e.y/box2d.scale,e.angle&&(n.angle=Math.PI*e.angle/180);var r=new b2FixtureDef;r.density=t.density,r.friction=t.friction,r.restitution=t.restitution,r.shape=new b2CircleShape(e.radius/box2d.scale);var i=box2d.world.CreateBody(n);i.SetUserData(e);var s=i.CreateFixture(r);return i}},loader={loaded:!0,loadedCount:0,totalCount:0,init:function(){var e,t,n=document.createElement("audio");n.canPlayType?(e=""!==n.canPlayType("audio/mpeg"),t=""!==n.canPlayType('audio/ogg; codecs="vorbis"')):(e=!1,t=!1),loader.soundFileExtn=t?".ogg":e?".mp3":undefined;var r,i,s=document.createElement("video");s.canPlayType?(i=""!==(s.canPlayType('video/mp4; codecs="avc1.42E01E"')||s.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')),r=""!==s.canPlayType('video/webm; codecs="vp8, vorbis"')):(i=!1,r=!1),loader.videoFileExtn=r?".webm":i?".mp4":undefined},loadImage:function(e,t){this.totalCount++,loader.updateStatus(),this.loaded=!1,$("#loadingscreen").show();var n=new Image;return n.src=e,n.onload=function(e){loader.itemLoaded(e),t&&t(n)},n},soundFileExtn:".ogg",loadSound:function(e){var t=new Audio;return loader.soundFileExtn?(this.totalCount++,loader.updateStatus(),this.loaded=!1,$("#loadingscreen").show(),t.addEventListener("canplaythrough",loader.itemLoaded,!1),t.preload="auto",t.src=e+loader.soundFileExtn,t.load(),t):t},loadVideo:function(e){var t=document.createElement("video");return loader.videoFileExtn?(this.totalCount++,loader.updateStatus(),this.loaded=!1,$("#loadingscreen").show(),t.addEventListener("canplaythrough",loader.itemLoaded,!1),t.preload="auto",t.src=e+loader.videoFileExtn,t.load(),t):t},itemLoaded:function(e){e.target.removeEventListener("canplaythrough",loader.itemLoaded,!1),e.target.removeEventListener("canplay",loader.itemLoaded,!1),e.target.removeEventListener("loadeddata",loader.itemLoaded,!1),loader.loadedCount++,loader.updateStatus(),loader.loadedCount===loader.totalCount&&(loader.loaded=!0,loader.loadedCount=0,loader.totalCount=0,$("#loadingscreen").hide(),loader.onload&&(loader.onload(),loader.onload=undefined))},updateStatus:function(){$("#loadingmessage").html("Loading "+loader.loadedCount+" of "+loader.totalCount+"...");var e=loader.totalCount?Math.round(100*loader.loadedCount/loader.totalCount):100}},mouse={x:0,y:0,down:!1,init:function(){$("#gamecanvas").mousemove(mouse.mousemovehandler),$("#gamecanvas").mousedown(mouse.mousedownhandler),$("#gamecanvas").mouseup(mouse.mouseuphandler),$("#gamecanvas").mouseout(mouse.mouseuphandler)},mousemovehandler:function(e){var t=$("#gamecanvas").offset();mouse.x=e.pageX-t.left,mouse.y=e.pageY-t.top,mouse.down&&(mouse.dragging=!0)},mousedownhandler:function(e){mouse.down=!0,mouse.downX=mouse.x,mouse.downY=mouse.y,e.originalEvent.preventDefault()},mouseuphandler:function(e){mouse.down=!1,mouse.dragging=!1}};